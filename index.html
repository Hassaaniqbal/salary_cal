<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Salary Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .config-section h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .config-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .config-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-box p {
            color: #004085;
            margin: 5px 0;
        }

        .upload-section {
            padding: 40px;
        }

        .upload-box {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .upload-box.dragover {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .upload-icon {
            font-size: 4em;
            color: #adb5bd;
            margin-bottom: 20px;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-info {
            margin-top: 15px;
            color: #6c757d;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card p {
            color: #6c757d;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card.green .stat-value { color: #28a745; }
        .stat-card.red .stat-value { color: #dc3545; }
        .stat-card.blue .stat-value { color: #667eea; }

        .attendance-table {
            margin: 30px 0;
        }

        .attendance-table h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        thead {
            background: #667eea;
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
        }

        tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
        }

        .salary-section {
            margin-top: 40px;
        }

        .salary-section h2 {
            font-size: 2em;
            margin-bottom: 30px;
            color: #333;
        }

        .salary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .salary-card {
            padding: 30px;
            border-radius: 15px;
            border: 2px solid;
        }

        .salary-card.credits {
            background: #d4edda;
            border-color: #28a745;
        }

        .salary-card.deductions {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .salary-card h3 {
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .salary-card.credits h3 { color: #155724; }
        .salary-card.deductions h3 { color: #721c24; }

        .salary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .salary-row:last-child {
            border-bottom: none;
        }

        .salary-row.total {
            border-top: 2px solid;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .final-salary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
        }

        .final-salary p:first-child {
            font-size: 1.3em;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .final-salary .amount {
            font-size: 3.5em;
            font-weight: bold;
            margin: 20px 0;
        }

        .final-salary .details {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .salary-grid {
                grid-template-columns: 1fr;
            }

            .final-salary .amount {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∞ Employee Salary Calculator</h1>
            <p>Upload attendance Excel file to calculate salary automatically</p>
        </div>

        <!-- Configuration Section -->
        <div class="config-section">
            <h2>‚öôÔ∏è Salary Configuration</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label>Base Salary</label>
                    <input type="number" id="baseSalary" value="40000">
                </div>
                <div class="config-item">
                    <label>OT Rate/Hour</label>
                    <input type="number" id="otRate" value="150">
                </div>
                <div class="config-item">
                    <label>Bonus (Full Attendance)</label>
                    <input type="number" id="bonus" value="5000">
                </div>
                <div class="config-item">
                    <label>Food Deduction</label>
                    <input type="number" id="foodDeduction" value="14000">
                </div>
                <div class="config-item">
                    <label>Paid Leaves Allowed</label>
                    <input type="number" id="paidLeaves" value="2">
                </div>
                <div class="config-item">
                    <label>Advance Given</label>
                    <input type="number" id="advanceAmount" value="0">
                </div>
            </div>
            <div class="info-box">
                <p>üïê Working Hours: 10:00 AM - 7:00 PM | OT starts from 7:00 PM onwards</p>
                <p>üìÖ Full attendance bonus: Given only if employee has ZERO absents</p>
                <p>üèñÔ∏è Paid Leaves: Configurable paid leaves per month (salary included in base)</p>
                <p>üí∞ Per Day Salary = Base Salary √∑ (Total Days in Month - Paid Leaves Allowed)</p>
                <p>‚è∞ Half Day: Detected if left at/before 5 PM OR arrived after 12 PM (Deduction = Per Day Salary √∑ 2)</p>
                <p>‚è±Ô∏è Late Penalty: Arrival after 10:30 AM (up to 11:59 AM) ‚Üí Minutes from 10:00 AM √ó OT rate/min deducted</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">üìÅ</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Upload Excel File
                </button>
                <p class="upload-info">Upload attendance Excel file with clock-in and clock-out times</p>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>
            <div id="loadingIndicator" class="loading hidden">
                <div class="spinner"></div>
                <p>Processing file...</p>
            </div>

            <!-- Stats -->
            <div id="statsSection" class="hidden">
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <p>Total Days in Month</p>
                        <div class="stat-value" id="totalDaysInMonth">0</div>
                    </div>
                    <div class="stat-card green">
                        <p>Total Work Days</p>
                        <div class="stat-value" id="totalWorkDays">0</div>
                    </div>
                    <div class="stat-card red">
                        <p>Absent Days</p>
                        <div class="stat-value" id="absentDays">0</div>
                    </div>
                    <div class="stat-card blue">
                        <p>Total OT Hours</p>
                        <div class="stat-value" id="totalOTHours">0</div>
                    </div>
                    <div class="stat-card green">
                        <p>Paid Leaves Used</p>
                        <div class="stat-value" id="paidLeavesUsed">0</div>
                    </div>
                    <div class="stat-card red">
                        <p>Unpaid Absents</p>
                        <div class="stat-value" id="unpaidAbsents">0</div>
                    </div>
                    <div class="stat-card blue">
                        <p>Half Days</p>
                        <div class="stat-value" id="halfDays">0</div>
                    </div>
                    <div class="stat-card red">
                        <p>Late Penalty (mins)</p>
                        <div class="stat-value" id="latePenaltyMinutes">0</div>
                    </div>
                </div>
            </div>

            <!-- Attendance Table -->
            <div id="attendanceSection" class="attendance-table hidden">
                <h2>üìÖ Attendance Details</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Clock In</th>
                                <th>Clock Out</th>
                                <th>OT Hours</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Salary Breakdown -->
            <div id="salarySection" class="salary-section hidden">
                <h2>üíµ Salary Breakdown</h2>
                <div class="salary-grid">
                    <!-- Credits -->
                    <div class="salary-card credits">
                        <h3>Credits</h3>
                        <div id="creditsContent"></div>
                    </div>

                    <!-- Deductions -->
                    <div class="salary-card deductions">
                        <h3>Deductions</h3>
                        <div id="deductionsContent"></div>
                    </div>
                </div>

                <!-- Final Salary -->
                <div class="final-salary">
                    <p>FINAL SALARY</p>
                    <div class="amount" id="finalAmount">Rs. 0</div>
                    <div class="details" id="finalDetails"></div>
                    <button class="upload-btn" id="downloadReportBtn" onclick="downloadReport()" style="margin-top: 30px;">
                        üìÑ Download PDF Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div style="text-align: center; padding: 30px 20px; background: #2c3e50; color: white; margin-top: 40px;">
        <p style="font-size: 14px; margin-bottom: 5px;">¬© 2025 All Rights Reserved - HASSAAN</p>
        <p style="font-size: 12px; opacity: 0.8;">Employee Salary Calculator System</p>
    </div>

    <script>
        const config = {
            baseSalary: 40000,
            otRate: 150,
            bonus: 5000,
            foodDeduction: 14000,
            paidLeaves: 2,
            advanceAmount: 0,
            workStartTime: 10,
            workEndTime: 19,
            otStartTime: 19
        };

        // Store processed data for recalculation
        let processedData = null;

        // Update config when inputs change and recalculate
        document.getElementById('baseSalary').addEventListener('input', (e) => {
            config.baseSalary = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        document.getElementById('baseSalary').addEventListener('change', (e) => {
            config.baseSalary = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        
        document.getElementById('otRate').addEventListener('input', (e) => {
            config.otRate = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        document.getElementById('otRate').addEventListener('change', (e) => {
            config.otRate = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        
        document.getElementById('bonus').addEventListener('input', (e) => {
            config.bonus = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        document.getElementById('bonus').addEventListener('change', (e) => {
            config.bonus = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        
        document.getElementById('foodDeduction').addEventListener('input', (e) => {
            config.foodDeduction = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        document.getElementById('foodDeduction').addEventListener('change', (e) => {
            config.foodDeduction = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        
        document.getElementById('paidLeaves').addEventListener('input', (e) => {
            config.paidLeaves = parseInt(e.target.value) || 0;
            recalculateIfDataExists();
        });
        document.getElementById('paidLeaves').addEventListener('change', (e) => {
            config.paidLeaves = parseInt(e.target.value) || 0;
            recalculateIfDataExists();
        });

        document.getElementById('advanceAmount').addEventListener('input', (e) => {
            config.advanceAmount = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });
        document.getElementById('advanceAmount').addEventListener('change', (e) => {
            config.advanceAmount = parseFloat(e.target.value) || 0;
            recalculateIfDataExists();
        });

        function recalculateIfDataExists() {
            if (processedData) {
                displayResults(processedData.attendanceData, processedData.totalWorkDays, processedData.absentDays, processedData.totalOTHours, processedData.totalDaysInMonth, processedData.halfDayCount, processedData.totalLatePenaltyMinutes);
                calculateSalary(processedData.totalWorkDays, processedData.totalOTMinutes, processedData.absentDays, processedData.totalDaysInMonth, processedData.halfDayCount, processedData.totalLatePenaltyMinutes);
            }
        }

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadBox = document.getElementById('uploadBox');

        fileInput.addEventListener('change', handleFileUpload);

        // Drag and drop
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('dragover');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            showLoading();
            hideError();
            hideResults();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    processWorkbook(workbook);
                } catch (error) {
                    showError('Error reading file. Please ensure it is a valid Excel file.');
                    console.error(error);
                } finally {
                    hideLoading();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function convertTimeToHHMM(timeValue) {
            // Convert to HH.MM format (e.g., 20.49 means 20 hours 49 minutes)
            if (typeof timeValue === 'number') {
                return timeValue;
            }
            if (typeof timeValue === 'string') {
                const parts = timeValue.split(/[:.]/);
                if (parts.length >= 2) {
                    return parseFloat(parts[0]) + parseFloat(parts[1]) / 100;
                }
                return parseFloat(timeValue);
            }
            return 0;
        }

        function calculateOTHours(inTime, outTime) {
            const outHHMM = convertTimeToHHMM(outTime);
            const otStartHHMM = 19.00; // 7 PM

            if (outHHMM <= otStartHHMM) {
                return 0;
            }

            // Calculate OT in HH.MM format
            const outHours = Math.floor(outHHMM);
            const outMinutes = Math.round((outHHMM - outHours) * 100);

            const otStartHours = Math.floor(otStartHHMM);
            const otStartMinutes = Math.round((otStartHHMM - otStartHours) * 100);

            console.log(`üîç OT Calc Detail: ClockOut=${outTime} ‚Üí ${outHHMM} ‚Üí ${outHours}h ${outMinutes}m ‚Üí Total: ${(outHours * 60 + outMinutes)} mins | OT Start: 1140 mins | Difference: ${(outHours * 60 + outMinutes) - 1140} mins`);

            // Calculate difference in minutes
            let otMinutesTotal = (outHours * 60 + outMinutes) - (otStartHours * 60 + otStartMinutes);
            let otHoursResult = Math.floor(otMinutesTotal / 60);
            let otMinutesResult = otMinutesTotal % 60;

            // Return in HH.MM format
            return otHoursResult + (otMinutesResult / 100);
        }

        function formatTime(hhmmValue) {
            const hours = Math.floor(hhmmValue);
            const minutes = Math.round((hhmmValue - hours) * 100);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
        }

        function processWorkbook(workbook) {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
                defval: '',
                raw: false
            });

            console.log('=== EXCEL FILE DEBUG ===');
            console.log('First 10 rows of Excel:', jsonData.slice(0, 10));
            console.log('=======================');

            const attendanceData = [];
            let totalOTHours = 0;
            let totalOTMinutesAccumulator = 0; // Track actual total minutes correctly
            let totalWorkDays = 0;
            let absentDays = 0;
            let totalDaysInMonth = 0;
            let halfDayCount = 0;
            let totalLatePenaltyMinutes = 0;
            let otDetailsForTable = [];

            // Get total days in month from row 1 (date range)
            if (jsonData[1] && jsonData[1][1]) {
                const dateRange = jsonData[1][1]; // e.g., "2025/09/01-2025/09/30"
                const dateParts = dateRange.split('-');
                if (dateParts.length === 2) {
                    const endDate = dateParts[1].trim();
                    const endDateParts = endDate.split('/');
                    if (endDateParts.length === 3) {
                        totalDaysInMonth = parseInt(endDateParts[2]) || 0;
                    }
                }
            }

            // Try to get absent days from different possible locations
            // Try row 4 (index 4)
            if (jsonData[4]) {
                for (let col = 0; col < jsonData[4].length; col++) {
                    const value = parseFloat(jsonData[4][col]);
                    if (!isNaN(value) && value > 0) {
                        absentDays = value;
                        console.log('Found absent days in row 4, column', col, ':', absentDays);
                        break;
                    }
                }
            }

            // Parse attendance records starting from row 9 (row 10 in Excel)
            for (let i = 9; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || !row[0] || row[0] === '') break;

                const date = row[0];
                const weekDay = row[1];
                const clockIn = row[2];
                const clockOut = row[3];

                if (clockIn && clockOut) {
                    const clockInHHMM = convertTimeToHHMM(clockIn);
                    const clockOutHHMM = convertTimeToHHMM(clockOut);
                    const otHours = calculateOTHours(clockIn, clockOut);

                    // Collect OT details for table
                    const otHoursInt = Math.floor(otHours);
                    const otMinutesFromDecimal = Math.round((otHours - otHoursInt) * 100);
                    const totalOTMinutesForDay = (otHoursInt * 60) + otMinutesFromDecimal;

                    otDetailsForTable.push({
                        Date: date,
                        'Clock Out': formatTime(clockOutHHMM),
                        'OT (HH.MM)': otHours.toFixed(2),
                        'Hours': otHoursInt,
                        'Minutes': otMinutesFromDecimal,
                        'Total OT Minutes': totalOTMinutesForDay
                    });

                    totalOTHours += otHours;
                    totalOTMinutesAccumulator += totalOTMinutesForDay; // Accumulate actual minutes
                    totalWorkDays++;

                    // Check if it's a half day:
                    // 1. Left at or before 5 PM (17.00)
                    // 2. Arrived after 12 PM (12.00)
                    const isHalfDay = clockOutHHMM <= 17.00 || clockInHHMM > 12.00;
                    if (isHalfDay) {
                        halfDayCount++;
                    }

                    // Calculate late penalty (if arrived after 10:30 AM and before 12:00 PM)
                    // Penalty minutes are calculated from 10:00 AM
                    let latePenaltyMinutes = 0;
                    const lateThreshold = 10.30; // Penalty applies after 10:30 AM
                    const latePenaltyCutoff = 12.00; // 12:00 PM
                    const penaltyBaseTime = 10.00; // Penalty calculated from 10:00 AM

                    if (clockInHHMM > lateThreshold && clockInHHMM < latePenaltyCutoff) {
                        // Convert clock-in time to minutes
                        const clockInHours = Math.floor(clockInHHMM);
                        const clockInMinutes = Math.round((clockInHHMM - clockInHours) * 100);
                        const clockInTotalMinutes = clockInHours * 60 + clockInMinutes;

                        // Convert base time (10:00 AM) to minutes
                        const baseHours = Math.floor(penaltyBaseTime);
                        const baseTotalMinutes = baseHours * 60;

                        // Calculate penalty from 10:00 AM
                        latePenaltyMinutes = clockInTotalMinutes - baseTotalMinutes;
                        totalLatePenaltyMinutes += latePenaltyMinutes;
                    }

                    attendanceData.push({
                        date,
                        weekDay,
                        clockIn: clockInHHMM,
                        clockOut: clockOutHHMM,
                        otHours: otHours.toFixed(2),
                        isHalfDay: isHalfDay,
                        latePenaltyMinutes: latePenaltyMinutes
                    });
                }
            }

            // If absent days not found in row 4, calculate from total days - work days
            if (absentDays === 0 && totalDaysInMonth > 0) {
                absentDays = totalDaysInMonth - totalWorkDays;
                console.log('Calculated absent days:', totalDaysInMonth, '-', totalWorkDays, '=', absentDays);
            }

            console.log('Final absent days:', absentDays);

            // Display OT details table
            console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('                    üìä DAILY OT BREAKDOWN                     ');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.table(otDetailsForTable);

            // Calculate total OT minutes
            const totalOTMinutesSum = otDetailsForTable.reduce((sum, day) => sum + day['Total OT Minutes'], 0);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üî¢ TOTAL OT MINUTES:', totalOTMinutesSum, 'minutes');
            console.log('üí∞ OT Rate per Minute: Rs.', (config.otRate / 60).toFixed(2));
            console.log('üíµ Total OT Payment: Rs.', (totalOTMinutesSum * (config.otRate / 60)).toFixed(2));
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

            // Store processed data for recalculation
            processedData = {
                attendanceData,
                totalWorkDays,
                absentDays,
                totalOTHours,
                totalOTMinutes: totalOTMinutesAccumulator, // Store the correct total minutes
                totalDaysInMonth,
                halfDayCount,
                totalLatePenaltyMinutes
            };

            displayResults(attendanceData, totalWorkDays, absentDays, totalOTHours, totalDaysInMonth, halfDayCount, totalLatePenaltyMinutes);
            calculateSalary(totalWorkDays, totalOTMinutesAccumulator, absentDays, totalDaysInMonth, halfDayCount, totalLatePenaltyMinutes);
        }

        function displayResults(attendanceData, totalWorkDays, absentDays, totalOTHours, totalDaysInMonth, halfDayCount, totalLatePenaltyMinutes) {
            // Calculate paid leaves and unpaid absents
            const paidLeavesUsed = Math.min(absentDays, config.paidLeaves);
            const unpaidAbsents = Math.max(0, absentDays - config.paidLeaves);

            // Update stats
            document.getElementById('totalDaysInMonth').textContent = totalDaysInMonth;
            document.getElementById('totalWorkDays').textContent = totalWorkDays;
            document.getElementById('absentDays').textContent = absentDays;
            document.getElementById('totalOTHours').textContent = totalOTHours.toFixed(2);
            document.getElementById('paidLeavesUsed').textContent = paidLeavesUsed;
            document.getElementById('unpaidAbsents').textContent = unpaidAbsents;
            document.getElementById('halfDays').textContent = halfDayCount;
            document.getElementById('latePenaltyMinutes').textContent = totalLatePenaltyMinutes;
            document.getElementById('statsSection').classList.remove('hidden');

            // Update attendance table
            const tableBody = document.getElementById('attendanceTableBody');
            tableBody.innerHTML = '';
            
            attendanceData.forEach(record => {
                const row = document.createElement('tr');
                const halfDayReason = record.isHalfDay ?
                    (record.clockOut <= 17.00 ? 'Left ‚â§5PM' : record.clockIn > 12.00 ? 'Arrived >12PM' : '') : '';
                const lateWarning = record.latePenaltyMinutes > 0 ? `<span style="color: #ff6b6b; font-weight: bold;">‚è∞ Late ${record.latePenaltyMinutes}m</span>` : '';
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.weekDay}</td>
                    <td>${formatTime(record.clockIn)} ${lateWarning} ${record.clockIn > 12.00 ? '<span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è</span>' : ''}</td>
                    <td>${formatTime(record.clockOut)} ${record.clockOut <= 17.00 ? '<span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è</span>' : ''}</td>
                    <td style="color: #667eea; font-weight: bold;">${record.otHours} ${record.isHalfDay ? `<br><span style="color: #dc3545; font-size: 0.85em;">${halfDayReason}</span>` : ''}</td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('attendanceSection').classList.remove('hidden');
        }

        function calculateSalary(workDays, totalOTMinutes, absentDays, totalDaysInMonth, halfDayCount, totalLatePenaltyMinutes) {
            // Calculate per day salary: Base Salary / (Total Days - Paid Leaves)
            const effectiveWorkingDays = totalDaysInMonth - config.paidLeaves;
            const perDaySalary = config.baseSalary / effectiveWorkingDays;

            // Calculate paid leaves and unpaid absents
            const paidLeavesUsed = Math.min(absentDays, config.paidLeaves);
            const unpaidAbsents = Math.max(0, absentDays - config.paidLeaves);

            // Deduct salary only for unpaid absents
            const absentDeduction = perDaySalary * unpaidAbsents;

            // Calculate half day deduction (half of per day salary for each half day)
            const halfDayDeduction = (perDaySalary / 2) * halfDayCount;

            // Calculate late penalty deduction (OT rate per minute √ó total late minutes)
            const latePenaltyDeduction = (config.otRate / 60) * totalLatePenaltyMinutes;

            // Use the passed totalOTMinutes directly (already calculated correctly)
            const otRatePerMinute = config.otRate / 60;

            // Calculate OT payment based on total minutes
            const otPayment = totalOTMinutes * otRatePerMinute;

            console.log('=== OT PAYMENT CALCULATION ===');
            console.log('Total OT Minutes:', totalOTMinutes);
            console.log('OT Rate per Hour:', config.otRate);
            console.log('OT Rate per Minute:', otRatePerMinute.toFixed(2));
            console.log('OT Payment:', totalOTMinutes, '√ó', otRatePerMinute.toFixed(2), '=', otPayment.toFixed(2));
            console.log('============================');
            const bonus = absentDays === 0 ? config.bonus : 0;
            const totalCredits = config.baseSalary + otPayment + bonus;

            const deductions = {
                food: config.foodDeduction,
                absent: absentDeduction,
                advance: config.advanceAmount,
                halfDay: halfDayDeduction,
                latePenalty: latePenaltyDeduction
            };

            const totalDeductions = Object.values(deductions).reduce((sum, val) => sum + val, 0);
            const finalSalary = totalCredits - totalDeductions;

            // Debug logging
            console.log('=== SALARY CALCULATION DEBUG ===');
            console.log('Total Days in Month:', totalDaysInMonth);
            console.log('Paid Leaves Allowed:', config.paidLeaves);
            console.log('Effective Working Days:', effectiveWorkingDays);
            console.log('Per Day Salary:', perDaySalary.toFixed(2));
            console.log('Absent Days:', absentDays);
            console.log('Paid Leaves Used:', paidLeavesUsed);
            console.log('Unpaid Absents:', unpaidAbsents);
            console.log('Absent Deduction:', absentDeduction.toFixed(2));
            console.log('Half Days:', halfDayCount);
            console.log('Half Day Deduction:', halfDayDeduction.toFixed(2));
            console.log('Late Penalty Minutes:', totalLatePenaltyMinutes);
            console.log('Late Penalty Deduction:', latePenaltyDeduction.toFixed(2));
            console.log('================================');

            // Display credits
            const creditsHTML = `
                <div class="salary-row">
                    <span>Base Salary</span>
                    <span><strong>Rs. ${config.baseSalary.toLocaleString()}</strong></span>
                </div>
                <div class="salary-row">
                    <span>OT Payment (${totalOTMinutes} mins √ó Rs.${otRatePerMinute.toFixed(2)})</span>
                    <span><strong>Rs. ${otPayment.toFixed(2)}</strong></span>
                </div>
                <div class="salary-row">
                    <span>Full Attendance Bonus ${absentDays === 0 ? '‚úì' : '‚úó'}</span>
                    <span><strong>Rs. ${bonus.toFixed(2)}</strong></span>
                </div>
                ${paidLeavesUsed > 0 ? `
                <div class="salary-row" style="color: #28a745; font-size: 0.9em;">
                    <span>‚ÑπÔ∏è Paid Leaves Used: ${paidLeavesUsed} days</span>
                    <span><strong>Included in Base</strong></span>
                </div>` : ''}
                <div class="salary-row total" style="color: #155724; border-color: #155724;">
                    <span>Total Credits</span>
                    <span>Rs. ${totalCredits.toFixed(2)}</span>
                </div>
            `;
            document.getElementById('creditsContent').innerHTML = creditsHTML;

            // Display deductions
            const deductionsHTML = `
                <div class="salary-row">
                    <span>Food Deduction</span>
                    <span><strong>Rs. ${deductions.food.toFixed(2)}</strong></span>
                </div>
                ${unpaidAbsents > 0 ? `
                <div class="salary-row">
                    <span>Absent Deduction (${unpaidAbsents} days √ó Rs.${perDaySalary.toFixed(2)})</span>
                    <span><strong>Rs. ${deductions.absent.toFixed(2)}</strong></span>
                </div>` : ''}
                ${halfDayCount > 0 ? `
                <div class="salary-row">
                    <span>Half Day Deduction (${halfDayCount} days √ó Rs.${(perDaySalary / 2).toFixed(2)})</span>
                    <span><strong>Rs. ${deductions.halfDay.toFixed(2)}</strong></span>
                </div>` : ''}
                ${config.advanceAmount > 0 ? `
                <div class="salary-row">
                    <span>Advance</span>
                    <span><strong>Rs. ${deductions.advance.toFixed(2)}</strong></span>
                </div>` : ''}
                ${totalLatePenaltyMinutes > 0 ? `
                <div class="salary-row">
                    <span>Late Penalty (${totalLatePenaltyMinutes} mins √ó Rs.${(config.otRate / 60).toFixed(2)}/min)</span>
                    <span><strong>Rs. ${deductions.latePenalty.toFixed(2)}</strong></span>
                </div>` : ''}
                <div class="salary-row total" style="color: #721c24; border-color: #721c24;">
                    <span>Total Deductions</span>
                    <span>Rs. ${totalDeductions.toFixed(2)}</span>
                </div>
            `;
            document.getElementById('deductionsContent').innerHTML = deductionsHTML;

            // Display final salary
            document.getElementById('finalAmount').textContent = `Rs. ${finalSalary.toFixed(2).toLocaleString()}`;
            document.getElementById('finalDetails').innerHTML = `
                ${workDays} working days | ${totalOTMinutes} OT minutes
                ${paidLeavesUsed > 0 ? ` | ${paidLeavesUsed} paid leaves` : ''}
                ${unpaidAbsents > 0 ? ` | ${unpaidAbsents} unpaid absents` : ''}
                ${halfDayCount > 0 ? ` | ${halfDayCount} half days` : ''}
            `;

            document.getElementById('salarySection').classList.remove('hidden');
        }

        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('attendanceSection').classList.add('hidden');
            document.getElementById('salarySection').classList.add('hidden');
        }

        function downloadReport() {
            if (!processedData) {
                alert('Please upload an attendance file first!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const { attendanceData, totalWorkDays, absentDays, totalOTMinutes, totalDaysInMonth, halfDayCount, totalLatePenaltyMinutes } = processedData;

            // Calculate all values
            const effectiveWorkingDays = totalDaysInMonth - config.paidLeaves;
            const perDaySalary = config.baseSalary / effectiveWorkingDays;
            const paidLeavesUsed = Math.min(absentDays, config.paidLeaves);
            const unpaidAbsents = Math.max(0, absentDays - config.paidLeaves);
            const absentDeduction = perDaySalary * unpaidAbsents;
            const halfDayDeduction = (perDaySalary / 2) * halfDayCount;
            const latePenaltyDeduction = (config.otRate / 60) * totalLatePenaltyMinutes;

            const otRatePerMinute = config.otRate / 60;
            const otPayment = totalOTMinutes * otRatePerMinute;
            const otDecimalHours = totalOTMinutes / 60;
            
            const bonus = absentDays === 0 ? config.bonus : 0;

            const totalCredits = config.baseSalary + otPayment + bonus;
            const totalDeductions = config.foodDeduction + absentDeduction + config.advanceAmount + halfDayDeduction + latePenaltyDeduction;
            const finalSalary = totalCredits - totalDeductions;

            // Get current date
            const currentDate = new Date().toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let yPos = 20;

            // Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('EMPLOYEE SALARY REPORT', 105, yPos, { align: 'center' });
            yPos += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated on ${currentDate}`, 105, yPos, { align: 'center' });
            yPos += 15;

            // Configuration Details
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Configuration Details', 14, yPos);
            yPos += 8;

            doc.autoTable({
                startY: yPos,
                head: [['Parameter', 'Value']],
                body: [
                    ['Base Salary', `Rs. ${config.baseSalary.toLocaleString()}`],
                    ['OT Rate/Hour', `Rs. ${config.otRate}`],
                    ['Full Attendance Bonus', `Rs. ${config.bonus.toLocaleString()}`],
                    ['Food Deduction', `Rs. ${config.foodDeduction.toLocaleString()}`],
                    ['Paid Leaves Allowed', `${config.paidLeaves} days`],
                    ['Advance Given', `Rs. ${config.advanceAmount.toLocaleString()}`]
                ],
                theme: 'plain',
                styles: { fontSize: 10, textColor: [0, 0, 0] },
                headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.5, lineColor: [0, 0, 0] },
                bodyStyles: { lineWidth: 0.5, lineColor: [200, 200, 200] },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 80, halign: 'right' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Attendance Summary
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Attendance Summary', 14, yPos);
            yPos += 8;

            doc.autoTable({
                startY: yPos,
                head: [['Metric', 'Value']],
                body: [
                    ['Total Days in Month', `${totalDaysInMonth}`],
                    ['Total Work Days', `${totalWorkDays}`],
                    ['Absent Days', `${absentDays}`],
                    ['Paid Leaves Used', `${paidLeavesUsed}`],
                    ['Unpaid Absents', `${unpaidAbsents}`],
                    ['Half Days', `${halfDayCount}`],
                    ['Total OT', `${totalOTMinutes} minutes (${otDecimalHours.toFixed(2)} hours)`],
                    ['Late Penalty Minutes', `${totalLatePenaltyMinutes} minutes`]
                ],
                theme: 'plain',
                styles: { fontSize: 10, textColor: [0, 0, 0] },
                headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.5, lineColor: [0, 0, 0] },
                bodyStyles: { lineWidth: 0.5, lineColor: [200, 200, 200] },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 80, halign: 'right' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Daily Attendance Details
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Daily Attendance Details', 14, yPos);
            yPos += 8;

            const attendanceTableData = attendanceData.map(record => {
                const remarks = [];
                if (record.isHalfDay) {
                    if (record.clockOut <= 17.00) remarks.push('Half Day (Left <=5PM)');
                    if (record.clockIn > 12.00) remarks.push('Half Day (Arrived >12PM)');
                }
                if (record.latePenaltyMinutes > 0) {
                    remarks.push(`Late ${record.latePenaltyMinutes}m`);
                }
                return [
                    record.date,
                    record.weekDay,
                    formatTime(record.clockIn),
                    formatTime(record.clockOut),
                    record.otHours,
                    remarks.join(', ') || '-'
                ];
            });

            doc.autoTable({
                startY: yPos,
                head: [['Date', 'Day', 'Clock In', 'Clock Out', 'OT Hours', 'Remarks']],
                body: attendanceTableData,
                theme: 'plain',
                styles: { fontSize: 9, textColor: [0, 0, 0] },
                headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.5, lineColor: [0, 0, 0] },
                bodyStyles: { lineWidth: 0.5, lineColor: [200, 200, 200] },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 45 }
                }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Salary Calculation
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Salary Calculation', 14, yPos);
            yPos += 8;

            // Credits
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Credits', 14, yPos);
            yPos += 6;

            const creditsData = [
                ['Base Salary', `Rs. ${config.baseSalary.toLocaleString()}`],
                [`OT Payment (${totalOTMinutes} mins x Rs.${otRatePerMinute.toFixed(2)}/min)`, `Rs. ${otPayment.toFixed(2)}`],
                [`Full Attendance Bonus ${absentDays === 0 ? '(Applied)' : '(Not Applied)'}`, `Rs. ${bonus.toFixed(2)}`]
            ];

            if (paidLeavesUsed > 0) {
                creditsData.push([`Paid Leaves Used: ${paidLeavesUsed} days`, 'Included in Base']);
            }

            doc.autoTable({
                startY: yPos,
                body: creditsData,
                theme: 'plain',
                styles: { fontSize: 10, textColor: [0, 0, 0] },
                bodyStyles: { lineWidth: 0.5, lineColor: [200, 200, 200] },
                columnStyles: {
                    0: { cellWidth: 120 },
                    1: { cellWidth: 60, halign: 'right', fontStyle: 'bold' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 2;

            // Total Credits
            doc.autoTable({
                startY: yPos,
                body: [['Total Credits', `Rs. ${totalCredits.toFixed(2)}`]],
                theme: 'plain',
                styles: { fontSize: 11, textColor: [0, 0, 0], fontStyle: 'bold' },
                bodyStyles: { lineWidth: 0.5, lineColor: [0, 0, 0] },
                columnStyles: {
                    0: { cellWidth: 120 },
                    1: { cellWidth: 60, halign: 'right' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 10;

            // Deductions
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Deductions', 14, yPos);
            yPos += 6;

            const deductionsData = [
                ['Food Deduction', `Rs. ${config.foodDeduction.toFixed(2)}`]
            ];

            if (unpaidAbsents > 0) {
                deductionsData.push([`Absent Deduction (${unpaidAbsents} days x Rs.${perDaySalary.toFixed(2)})`, `Rs. ${absentDeduction.toFixed(2)}`]);
            }

            if (halfDayCount > 0) {
                deductionsData.push([`Half Day Deduction (${halfDayCount} days x Rs.${(perDaySalary / 2).toFixed(2)})`, `Rs. ${halfDayDeduction.toFixed(2)}`]);
            }

            if (config.advanceAmount > 0) {
                deductionsData.push(['Advance', `Rs. ${config.advanceAmount.toFixed(2)}`]);
            }

            if (totalLatePenaltyMinutes > 0) {
                deductionsData.push([`Late Penalty (${totalLatePenaltyMinutes} mins x Rs.${(config.otRate / 60).toFixed(2)}/min)`, `Rs. ${latePenaltyDeduction.toFixed(2)}`]);
            }

            doc.autoTable({
                startY: yPos,
                body: deductionsData,
                theme: 'plain',
                styles: { fontSize: 10, textColor: [0, 0, 0] },
                bodyStyles: { lineWidth: 0.5, lineColor: [200, 200, 200] },
                columnStyles: {
                    0: { cellWidth: 120 },
                    1: { cellWidth: 60, halign: 'right', fontStyle: 'bold' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 2;

            // Total Deductions
            doc.autoTable({
                startY: yPos,
                body: [['Total Deductions', `Rs. ${totalDeductions.toFixed(2)}`]],
                theme: 'plain',
                styles: { fontSize: 11, textColor: [0, 0, 0], fontStyle: 'bold' },
                bodyStyles: { lineWidth: 0.5, lineColor: [0, 0, 0] },
                columnStyles: {
                    0: { cellWidth: 120 },
                    1: { cellWidth: 60, halign: 'right' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Final Salary Box
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(1);
            doc.rect(14, yPos, 182, 25);
            
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('FINAL SALARY', 105, yPos, { align: 'center' });
            
            yPos += 10;
            doc.setFontSize(18);
            doc.text(`Rs. ${finalSalary.toFixed(2).toLocaleString()}`, 105, yPos, { align: 'center' });

            yPos += 12;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            const detailsText = `${totalWorkDays} working days | ${totalOTMinutes} OT minutes` +
                (paidLeavesUsed > 0 ? ` | ${paidLeavesUsed} paid leaves` : '') +
                (unpaidAbsents > 0 ? ` | ${unpaidAbsents} unpaid absents` : '') +
                (halfDayCount > 0 ? ` | ${halfDayCount} half days` : '');
            doc.text(detailsText, 105, yPos, { align: 'center' });

            // Calculation Formulas
            yPos += 15;

            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Calculation Formulas', 14, yPos);
            yPos += 8;

            doc.autoTable({
                startY: yPos,
                body: [
                    ['Effective Working Days', `${totalDaysInMonth} - ${config.paidLeaves} = ${effectiveWorkingDays} days`],
                    ['Per Day Salary', `Rs.${config.baseSalary} / ${effectiveWorkingDays} = Rs.${perDaySalary.toFixed(2)}`],
                    ['Half Day Rate', `Rs.${perDaySalary.toFixed(2)} / 2 = Rs.${(perDaySalary / 2).toFixed(2)}`],
                    ['Late Penalty Rate', `Rs.${config.otRate} / 60 = Rs.${(config.otRate / 60).toFixed(2)}/min`]
                ],
                theme: 'plain',
                styles: { fontSize: 10, textColor: [0, 0, 0] },
                bodyStyles: { lineWidth: 0.5, lineColor: [200, 200, 200] },
                columnStyles: {
                    0: { cellWidth: 80, fontStyle: 'bold' },
                    1: { cellWidth: 100 }
                }
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('This is an auto-generated salary report.', 105, 280, { align: 'center' });
                doc.text('Generated using Employee Salary Calculator', 105, 285, { align: 'center' });
                doc.setFont(undefined, 'bold');
                doc.text('¬© 2025 All Rights Reserved - HASSAAN', 105, 290, { align: 'center' });
            }

            // Save PDF
            doc.save(`Salary_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }
    </script>
</body>
</html>